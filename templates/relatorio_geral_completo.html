{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" style="font-weight:800; letter-spacing:1px; color:#fff;">Relatório Geral Completo</h2>
        <div>
            <a href="{{ url_for('relatorio_geral_pdf') }}" class="btn btn-primary"><i class="bi bi-file-earmark-pdf"></i> Exportar PDF</a>
            <button onclick="exportarRelatorio()" class="btn btn-outline-primary ms-2"><i class="bi bi-download"></i> Exportar CSV</button>
        </div>
    </div>
    
    <!-- Resumo Geral -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-body">
                    <h2 class="card-title mb-1" id="total-produtos" style="font-size:2.2rem; font-weight:900;">-</h2>
                    <p class="card-text text-uppercase text-secondary">Total de Produtos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-body">
                    <h2 class="card-title mb-1" id="total-estoque" style="font-size:2.2rem; font-weight:900;">-</h2>
                    <p class="card-text text-uppercase text-secondary">Itens em Estoque</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-body">
                    <h2 class="card-title mb-1" id="valor-estoque" style="font-size:2.2rem; font-weight:900;">-</h2>
                    <p class="card-text text-uppercase text-secondary">Valor Total Estoque</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-body">
                    <h2 class="card-title mb-1" id="data-relatorio" style="font-size:1.1rem; font-weight:700;">-</h2>
                    <p class="card-text text-uppercase text-secondary">Data do Relatório</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendas do Mês -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-header border-0" style="background:#181c22; color:#fff; font-weight:700;">Vendas do Mês Atual</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Total de Vendas:</strong> <span id="total-vendas">-</span></p>
                            <p><strong>Quantidade Vendida:</strong> <span id="qtd-vendida">-</span></p>
                        </div>
                        <div class="col-6">
                            <p><strong>Valor das Vendas:</strong> R$ <span id="valor-vendas">-</span></p>
                            <p><strong>Margem de Lucro:</strong> R$ <span id="margem-lucro">-</span></p>
                            <p><strong>Margem Média:</strong> <span id="margem-media">-</span>%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-header border-0" style="background:#181c22; color:#fff; font-weight:700;">Alertas</div>
                <div class="card-body">
                    <div id="alertas-container">
                        <p class="text-muted">Carregando alertas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Produtos Mais Vendidos e Margens -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-header border-0" style="background:#181c22; color:#fff; font-weight:700;">Produtos Mais Vendidos (30 dias)</div>
                <div class="card-body">
                    <div id="produtos-mais-vendidos">
                        <p class="text-muted">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-lg border-0" style="background:#23272f; color:#fff;">
                <div class="card-header border-0" style="background:#181c22; color:#fff; font-weight:700;">Top 10 Margens de Lucro</div>
                <div class="card-body">
                    <div id="produtos-margem">
                        <p class="text-muted">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Movimentações Recentes -->
    <div class="card mb-4 shadow-lg border-0" style="background:#23272f; color:#fff;">
        <div class="card-header border-0" style="background:#181c22; color:#fff; font-weight:700;">Movimentações Recentes</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Valor Unitário</th>
                        </tr>
                    </thead>
                    <tbody id="movimentacoes-recentes">
                        <tr><td colspan="5" class="text-center">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Categorias -->
    <div class="card shadow-lg border-0" style="background:#23272f; color:#fff;">
        <div class="card-header border-0" style="background:#181c22; color:#fff; font-weight:700;">Resumo por Categoria</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Quantidade em Estoque</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody id="categorias-tbody">
                        <tr><td colspan="3" class="text-center">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function carregarRelatorio() {
    fetch('/api/relatorio_geral_completo')
        .then(resp => resp.json())
        .then(data => {
            // Resumo Geral
            document.getElementById('total-produtos').textContent = data.resumo_geral.total_produtos;
            document.getElementById('total-estoque').textContent = data.resumo_geral.total_estoque;
            document.getElementById('valor-estoque').textContent = `R$ ${data.resumo_geral.valor_total_estoque.toFixed(2).replace('.', ',')}`;
            document.getElementById('data-relatorio').textContent = data.resumo_geral.data_relatorio;

            // Vendas do Mês
            document.getElementById('total-vendas').textContent = data.vendas_mes_atual.total_vendas;
            document.getElementById('qtd-vendida').textContent = data.vendas_mes_atual.quantidade_vendida;
            document.getElementById('valor-vendas').textContent = data.vendas_mes_atual.valor_vendas.toFixed(2).replace('.', ',');
            document.getElementById('margem-lucro').textContent = data.vendas_mes_atual.margem_lucro.toFixed(2).replace('.', ',');
            document.getElementById('margem-media').textContent = data.vendas_mes_atual.margem_media.toFixed(2).replace('.', ',');

            // Alertas
            let alertasHtml = '';
            if (data.alertas.total_alertas === 0) {
                alertasHtml = '<p class="text-success">Nenhum alerta encontrado.</p>';
            } else {
                if (data.alertas.estoque_baixo.length > 0) {
                    alertasHtml += '<h6 class="text-danger">Estoque Baixo:</h6><ul>';
                    data.alertas.estoque_baixo.forEach(a => {
                        alertasHtml += `<li>${a.produto} (${a.quantidade} unidades)</li>`;
                    });
                    alertasHtml += '</ul>';
                }
                if (data.alertas.estoque_alto.length > 0) {
                    alertasHtml += '<h6 class="text-warning">Estoque Alto:</h6><ul>';
                    data.alertas.estoque_alto.forEach(a => {
                        alertasHtml += `<li>${a.produto} (${a.quantidade} unidades)</li>`;
                    });
                    alertasHtml += '</ul>';
                }
            }
            document.getElementById('alertas-container').innerHTML = alertasHtml;

            // Produtos Mais Vendidos
            let maisVendidosHtml = '';
            if (data.produtos_mais_vendidos.length === 0) {
                maisVendidosHtml = '<p class="text-muted">Nenhuma venda nos últimos 30 dias.</p>';
            } else {
                data.produtos_mais_vendidos.forEach((p, index) => {
                    maisVendidosHtml += `<p><strong>${index + 1}.</strong> ${p.nome} - ${p.quantidade} unidades</p>`;
                });
            }
            document.getElementById('produtos-mais-vendidos').innerHTML = maisVendidosHtml;

            // Produtos Margem
            let margemHtml = '';
            if (data.produtos_margem.length === 0) {
                margemHtml = '<p class="text-muted">Nenhum produto com margem calculada.</p>';
            } else {
                data.produtos_margem.forEach((p, index) => {
                    margemHtml += `<p><strong>${index + 1}.</strong> ${p.nome} - ${p.margem}%</p>`;
                });
            }
            document.getElementById('produtos-margem').innerHTML = margemHtml;

            // Movimentações Recentes
            let movHtml = '';
            if (data.movimentacoes_recentes.length === 0) {
                movHtml = '<tr><td colspan="5" class="text-center">Nenhuma movimentação encontrada.</td></tr>';
            } else {
                data.movimentacoes_recentes.forEach(m => {
                    const tipoClass = m.tipo === 'venda' ? 'text-danger' : 'text-success';
                    movHtml += `<tr>
                        <td>${m.data}</td>
                        <td class="${tipoClass}">${m.tipo.toUpperCase()}</td>
                        <td>${m.produto}</td>
                        <td>${m.quantidade}</td>
                        <td>R$ ${m.valor_unitario.toFixed(2).replace('.', ',')}</td>
                    </tr>`;
                });
            }
            document.getElementById('movimentacoes-recentes').innerHTML = movHtml;

            // Categorias
            let catHtml = '';
            if (Object.keys(data.categorias).length === 0) {
                catHtml = '<tr><td colspan="3" class="text-center">Nenhuma categoria encontrada.</td></tr>';
            } else {
                Object.entries(data.categorias).forEach(([categoria, dados]) => {
                    catHtml += `<tr>
                        <td>${categoria}</td>
                        <td>${dados.quantidade}</td>
                        <td>R$ ${dados.valor.toFixed(2).replace('.', ',')}</td>
                    </tr>`;
                });
            }
            document.getElementById('categorias-tbody').innerHTML = catHtml;
        });
}

function exportarRelatorio() {
    fetch('/api/relatorio_geral_completo')
        .then(resp => resp.json())
        .then(data => {
            let csv = 'Relatório Geral Completo\n\n';
            csv += `Data: ${data.resumo_geral.data_relatorio}\n\n`;
            csv += 'RESUMO GERAL\n';
            csv += `Total de Produtos,${data.resumo_geral.total_produtos}\n`;
            csv += `Itens em Estoque,${data.resumo_geral.total_estoque}\n`;
            csv += `Valor Total Estoque,R$ ${data.resumo_geral.valor_total_estoque}\n\n`;
            
            csv += 'VENDAS DO MÊS\n';
            csv += `Total de Vendas,${data.vendas_mes_atual.total_vendas}\n`;
            csv += `Quantidade Vendida,${data.vendas_mes_atual.quantidade_vendida}\n`;
            csv += `Valor das Vendas,R$ ${data.vendas_mes_atual.valor_vendas}\n`;
            csv += `Margem de Lucro,R$ ${data.vendas_mes_atual.margem_lucro}\n`;
            csv += `Margem Média,${data.vendas_mes_atual.margem_media}%\n\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_geral_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });
}

// Carregar relatório ao abrir a página
carregarRelatorio();
</script>
{% endblock %} 